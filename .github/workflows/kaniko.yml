name: ðŸ§ª Test building with Kaniko

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [kaniko-worker]
    container:
      image: gcr.io/kaniko-project/executor:debug
    permissions:
      contents: read
      packages: write

    steps:
      - name: Build and push container test
        run: |
          # Write config file
          AUTH=$(echo -n ${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} | base64)
          echo "{\"auths\": {\"ghcr.io\": {\"auth\": \"${AUTH}\"}}}" > /kaniko/.docker/config.json

          # Configure git
          export GIT_USERNAME="rinoabraham"
          export GIT_PASSWORD="Abraham143#"

          # Build and push
          /kaniko/executor --dockerfile="/workspace/Dockerfile" \
            --context="git://github.com/rinoabraham2011/Testing.git" \
            --destination="rinoraju123/myrepo1/kaniko-build:test" \
            --push-retry 5 \
            --image-name-with-digest-file /workspace/image-digest.txt